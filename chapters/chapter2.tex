\chapter{State of the Art \& Related Work}
\label{cha:chapter2}


This chapter gives a look at the main ideas in blockchain scalability and introduces the core project on which this thesis is based.

\section{Scalability Approaches}
Various strategies are being explored to enhance blockchain scalability. Some are already operational, while others are in the research stage. These strategies broadly fall into two categories: Layer 1 and Layer 2 solutions \cite{tyagi_study_2021,thibault_blockchain_2022}. Layer 1 solutions focus on boosting blockchain scalability through means like enlarging block sizes or implementing Sharding. In contrast, Layer 2 solutions attempt to scale the blockchain by relocating computation off-chain. Noteworthy examples of Layer 2 solutions are State Channels, Sidechains, and Rollups, as illustrated in Figure \ref{fig:2_scalingSolutions}.

The common path for making blockchains handle more transactions is to use Layer 2 solutions. Many members of the Ethereum community are following this approach \cite{neiheiser_practical_2023}.

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.95\columnwidth]{2_scalingSolutions.jpg}
  \caption[Scaling Solutions]{Principal scaling solutions for Layer 1 and Layer 2\footnotemark}  
  \label{fig:2_scalingSolutions}
\end{figure} 
\footnotetext{\url{https://medium.com/token-terminal/a-primer-on-ethereum-l2-scaling-techniques-17ac437891b1}}

\section{Zk-Rollups}
\label{sec:2_zkRollups}
Zero-Knowledge Rollups represent a Layer 2 scaling approach that takes advantage of capabilities of zero-knowledge proofs to facilitate off-chain computation. This strategy aims to alleviate the scalability limitations of blockchains by shifting most of the computational work away from the main chain while still maintaining the security and trustless nature of the system. In the context of Zk-Rollups, computation is executed off-chain, and the outcomes of these computations, accompanied by a proof of verifiably correct execution, are transmitted to the corresponding smart contract on the blockchain \cite{tyagi_study_2021}.

Figure \ref{fig:2_zkRollup_schema} illustrates the fundamental steps of the Zk-Rollup, explained by this sequence list:
\begin{enumerate}
  \item \textbf{Transaction Initiation:} Users initiate transactions with an off-chain processing node. This node is responsible for collecting and batching multiple transactions together;
  \item \textbf{Off-chain Computation:} The processing node performs computations off-chain, fetching the current state from the underlying blockchain;
  \item \textbf{Proof Transmission:} After processing the transaction batch, the node generates a proof attesting to the validity of the computations performed. This proof, along with the resulting transaction outcomes, is then transmitted to the blockchain's smart contract;
  \item \textbf{Proof Verification:} The smart contract receives the proof and checks its correctness. This step involves cryptographic operations to confirm that the computation was executed correctly and honestly;
  \item \textbf{State Update:} If the proof verification is successful, the smart contract updates its internal state on the blockchain to store the outcomes of the off-chain computation. This ensures that the blockchain remains in sync with the results of the computations performed in the Layer 2 solution.
\end{enumerate}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.95\columnwidth]{2_zkRollup_architecture.png}
  \caption[Zk-Rollup Schema]{General schema of a Zk-Rollup\cite{ise_department_tub_material_nodate}}  
  \label{fig:2_zkRollup_schema}
\end{figure}

\subsection{Zk-Rollup Implementations}
Some other Zk-Rollup implementations exist, particularly for Ethereum. The implementation discussed in \cite{dinh_implementation_2023} shares similarities with the ADSP project's approach. However, it lacks considerations for system scaling and handling multiple token types. Another example is Polygon Zero\footnote{\url{https://polygon.technology/blog/introducing-plonky2}}, which facilitates parallel execution of transactions on L2. This system blends STARK and SNARK, differing from the approach outlined in this thesis. \cite{rybakken_intmax2_2023} presents an innovative approach to Zk-Rollup featuring stateless and decentralized block production, trying to limit the data stored on chain and moving the computations to the client-side. However, this approach follows a different path from the one presented in this thesis, which uses a more classic approach with a centralized smart contract and a decentralized node.

\subsection{Zk-Rollup Reviews}
Some studies have assessed the viability and performance of the Zk-Rollup system. \cite{capko_state_2022} offers an overview of prevalent zero-knowledge proofs. The ZoKrates Toolbox, utilized by the ADSP project, employs SNARK, which requires a trusted setup phaseâ€”a potential drawback compared to Transparent zk-SNARK \cite{zhou_overview_2022}. \cite{neiheiser_practical_2023} highlights the scalability bottleneck L2 solutions may face due to a possible slow L1, constraining them below theoretical L2 throughput. \cite{starkware_fractal_2021} proposes a new Layer 3 to overcome this issue.

\section{Alternative L2 Solutions}
Several Layer 2 strategies exist to scale blockchains, offering different approaches to address the scalability challenges faced by the blockchain. Below is a brief overview at some of these strategies.

\subsection{Plasma}
Plasma presents a dynamic off-chain transaction processing solution by introducing child chains or sidechains linked to the main blockchain. These connected chains, or "Plasma chains," allow for a significant increase in transaction throughput by handling transactions off the main chain. This results in faster and more efficient transactions. However, Plasma's architecture introduces a challenge: the need for resolving disputes that may arise due to potentially fraudulent or incorrect actions on these child chains\cite{thibault_blockchain_2022}. This dispute resolution process is necessary to maintain the security and integrity of the system. An example of a project utilizing the Plasma approach is OMG Network\footnote{\url{https://docs.omg.network}}, which uses Plasma chains to enhance transaction scalability while relying on the security guarantees of the main Ethereum blockchain.

\subsection{State Channels}
State channels provide a different Layer 2 scaling solution that focuses on specific use cases such as micropayments and gaming interactions. These channels allow users to execute transactions directly with each other off the main blockchain, thus reducing the congestion on the main chain and enabling faster, low-cost transactions\cite{negka_blockchain_2021}. State channels work by locking a certain amount of cryptocurrency on the blockchain and then allowing multiple off-chain transactions to occur between participants. These transactions are only confirmed on the main chain when the participants want to close the channel or when a dispute arises. An example of a project implementing state channels is Perun\footnote{\url{https://perun.network/wp-content/uploads/Perun2.0.pdf}}, which offers a framework for efficient state channel networks.

\subsection{Optimistic Rollups \label{subsec:optimisticRollups}}
Optimistic Rollups offer a compromise between transaction speed and security by assuming the validity of transactions by default\cite{thibault_blockchain_2022}. In this approach, transactions are processed quickly on Layer 2, but the verification of these transactions is postponed to the main blockchain only if disputes arise. This "optimistic" assumption speeds up the entire transaction processing while maintaining the chance for arbitration if necessary. It's worth noting that the vast majority of transactions are expected to be valid, so this approach optimizes for the common case. Optimistic Rollups combine the efficiency benefits of Layer 2 scaling with the security guarantees of the main blockchain. A notable downside of this solution is the presence of a long waiting time for a transaction to be confirmed on the main chain. This is due to the need of waiting for the maximum possible duration during which a dispute could potentially be raised within a rollup execution, which is called the "challenge period"\cite{negka_blockchain_2021}. This challenge period can last for about one week before a transaction is confirmed on the main chain.

\section{ZoKrates}

ZoKrates is a toolbox for zkSNARKs on Ethereum: it allows developers to write zero-knowledge proofs in a high-level programming language and generate trusted setup parameters and zero-knowledge proofs \cite{eberhardt_ZoKrates_2018}. It is in fact necessary to rely on a trusted setup phase to generate the proving and verifying keys, which are used to generate and verify the proofs.

This toolbox utilizes a C++ language style, facilitating developers adoption. It also offers a built-in library with frequently used functions like hash functions, elliptic curve operations, and Merkle tree operations. The toolbox is also capable of generating a Solidity contract from the ZoKrates program, deployable on the Ethereum blockchain. The contract can then be used to verify the proofs generated by the ZoKrates program. However, a drawback of this toolbox is the limited supported data types: due to the resource-intensive phases like computing the witness and generating a proof, the program must avoid using complex and memory-consuming types. For this reason the primitive types supported are integers, booleans and field values, whose size depends on the underlying elliptic curve.

Another constraint is that the toolbox requires loop sizes to be known during compile time. This becomes problematic when dealing, for instance, with a variable number of users, as the number of iterations of the loops depends on the number of users.

\section{ADSP Project: Scaling Tezos Blockchain with Zk-Rollups \label{sec:2_adspProject}}

In the Winter Semester 2022/2023 at the University of Berlin, I collaborated with the ADSP (Advanced Distributed Systems Prototype) group on a project. The project's objective was to scale the Tezos blockchain using Zk-Rollups through the ZoKrates toolbox.

The group partially achieved the project's objectives, creating a proof of concept. The system architecture features Layer 1 and Layer 2 components: Layer 1 includes two smart contracts for state management and proof verification; Layer 2 encompasses a node executing transactions within the ZoKrates program, generating proofs for the smart contract. Figure \ref{fig:2_general_rollup_architecture} offers an overview of the entire system.

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.95\columnwidth]{2_drawings-adsp_rollup_architecture.png}
  \caption[Project Architecture]{Project architecture}  
  \label{fig:2_general_rollup_architecture}
\end{figure}

The Zk-Rollup execution process occurs as follows:
\begin{enumerate}
    \item A user dispatches a transaction to the off-chain node, managed by a NodeJS server (the Web-Manager);
    \item The Web-Manager logs the transaction in a transaction queue;
    \item Once three transactions accumulate, the Web-Manager fetches the current state from the Tezos Zk-Rollup smart contract;
    \item The L2 node processes the transaction batch, executing the ZoKrates program using the transaction batch and the current state as input;
    \item The ZoKrates program generates a proof and new balance list;
    \item The node converts ZoKrates outputs into a Tezos-compatible format;
    \item Converted outputs are dispatched to the Tezos Rollup smart contract using Taquito, an external Typescript library;
    \item The smart contract forwards the proof to the verifier smart contract;
    \item The verifier smart contract verifies the proof, communicating the result to the Rollup-Manager contract;
    \item If the proof is verified, the new balance list is stored in the Manager contract's blockchain storage.
\end{enumerate}

Figure \ref{fig:2_drawings-adsp_sequence_general.png} illustrates the sequence of events in the Zk-Rollup execution process.

\begin{figure}[ht]
  \centering
  \includegraphics[width=1\columnwidth]{2_drawings-adsp_sequence_general.png}
  \caption[Sequence Zk-Rollup]{Sequence diagram of the Zk-Rollup execution process.}  
  \label{fig:2_drawings-adsp_sequence_general.png}
\end{figure} 

\subsection{Developed Components}
The team successfully implemented the Rollup-Manager \textit{Verify} entrypoint within the \textit{Rollup contract}, along with the \textit{NodeJS Manager}. Additionally, the storage mechanism was correctly executed.

The ZoKrates program was partially developed, including:
\begin{itemize}
    \item Verification of account inclusion in the rollup system;
    \item Verification of sufficient balance in sender account;
    \item Transaction execution;
    \item Generation of new balance merkle tree root, balance list, and proof.
\end{itemize}

The generation of the Merkle tree root is accomplished through the algorithm described below. This process utilizes the SHA2-256 hash function with automatic zero-padding. The algorithm incorporates pre-calculated values for the Merkle tree depth and the number of leaf nodes.

\noindent\textbf{Algorithm 1: Merkle Tree Root Generation}
\begin{lstlisting}[language=Python]
for i in 0...TREE_DEPTH {
  step_size = 2 ** (i + 1)
  step_number = LEAFS_NUM / step_size
  for j in 0...step_number {
    leftIndex = j * step_size
    rightIndex = leftIndex + step_size / 2
    leafs[leftIndex] = hash(
        leafs[leftIndex],
        leafs[rightIndex]
    )
  }
}
return leafs[0]
\end{lstlisting}

\subsection{Pending Components\label{subsec:pendingcomponents}}
Numerous aspects of the project remain unfinished, including:
\begin{itemize}
  \item Registration entrypoint;
  \item Deregistration entrypoint;
  \item Deposit entrypoint;
  \item Withdrawal entrypoint;
  \item Integration of signature checks within the ZoKrates program;
  \item Addressing the double spending issue;
  \item System optimization.
\end{itemize}
Furthermore, the project lacks a benchmarking study, a cost analysis and a proof of concept for a real-world application.
